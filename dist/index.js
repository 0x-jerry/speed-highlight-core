import expandData_ from"./common.js";const langs_={},sanitize_=(t="")=>t.replaceAll("&","&#38;").replaceAll?.("<","&lt;").replaceAll?.(">","&gt;"),toSpan_=(t,i)=>i?`<span class="shj-syn-${i}">${t}</span>`:t;async function tokenize(t,i,n){let a,e,l={},h,s=[],g=0,o="string"==typeof i?await(langs_[i]??=import(`./languages/${i}.js`)):i,c=[..."string"==typeof i?o.default:i.sub];for(;g<t.length;){for(l.t=null,a=c.length;0<a--;){if(e=c[a].expand?expandData_[c[a].expand]:c[a],void 0===s[a]||s[a].i.index<g){if(e.match.lastIndex=g,null===(h=e.match.exec(t))){c.splice(a,1),s.splice(a,1);continue}s[a]={i:h,l:e.match.lastIndex}}s[a].i[0]&&(s[a].i.index<=l.t||null===l.t)&&(l={h:e,t:s[a].i.index,i:s[a].i[0],g:s[a].l})}if(null===l.t)break;n(t.slice(g,l.t),o.type),g=l.g,l.h.sub?await tokenize(l.i,"string"==typeof l.h.sub?l.h.sub:l.h,n):n(l.i,l.h.type)}n(t.slice(g,t.length),o.type)}async function highlightText(t,i,n=!0){let a=n?`<div><div class="shj-numbers">${"<div></div>".repeat(t.split("\n").length)}</div><div>`:"";return await tokenize(t,i,(t,i)=>a+=toSpan_(sanitize_(t),i)),n&&(a+="</div></div>"),a}async function highlightElement(t,i=t.className.match(/shj-lang-([\w-]+)/)?.[1],n="CODE"!=t.tagName){t.dataset.lang=i,t.classList.add("shj-lang-"+i),t.innerHTML=await highlightText(t.textContent,i,n)}let highlightAll=async()=>document.querySelectorAll('[class*="shj-lang-"]').forEach(t=>highlightElement(t));export{tokenize,highlightText,highlightElement,highlightAll};